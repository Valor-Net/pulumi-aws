name: Update ECS Service Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
      service_name:
        description: 'Service name'
        required: true
      stack:
        description: 'Stack name'
        required: true
      commit_sha:
        description: 'Commit SHA'
        required: true
      ecr_repository:
        description: 'ECR Repository'
        required: true
      ecr_nginx_repository:
        description: 'ECR Nginx Repository'
        required: true
      ecs_cluster:
        description: 'ECS Cluster'
        required: true
      pulumi_service_name:
        description: 'Pulumi Service Name'
        required: true

jobs:
  update-service:
    runs-on: ubuntu-latest
    environment: staging
    name: Run ECS update - ${{ github.event.inputs.stack }} - ${{ github.event.inputs.service_name }}
    permissions:
      contents: write
      id-token: write
      actions: read

    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.INFRA_REPO_TOKEN }}
        persist-credentials: true 
      
    - name: Setup Pulumi
      uses: pulumi/actions@v4
      with:
        pulumi-version: ^3.0.0
        
    - name: Update Pulumi config and ECS Service
      env:
        PULUMI_CONFIG_PASSPHRASE: ""
        PULUMI_BACKEND_URL: ${{ secrets.PULUMI_BACKEND_URL }}
      run: |
        echo "ğŸ”„ Atualizando imagem do serviÃ§o: ${{ github.event.inputs.service_name }}"
        echo "ğŸ·ï¸ Nova imagem tag: ${{ github.event.inputs.image_tag }}"
        
        # Definir variÃ¡veis
        CLUSTER_NAME="${{ github.event.inputs.ecs_cluster }}"
        SERVICE_NAME="${{ github.event.inputs.service_name }}"
        ECR_REPOSITORY="${{ github.event.inputs.ecr_repository }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        STACK_NAME="${{ github.event.inputs.stack }}"
        
        # Construir a URI completa da imagem
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
        
        echo "ğŸ³ Nova imagem: ${IMAGE_URI}"
        
        # ========================================
        # 1. ATUALIZAR CONFIG DO PULUMI
        # ========================================
        echo "âš™ï¸ Atualizando configuraÃ§Ã£o do Pulumi..."
        
        # Selecionar stack
        pulumi stack select ${STACK_NAME}
        
        CONFIG_KEY="valornet-infra:${{github.event.inputs.pulumi_service_name}}.imageTag"
        
        echo "ğŸ“ Atualizando config: ${CONFIG_KEY} = ${IMAGE_TAG}"
        pulumi config set ${CONFIG_KEY} ${IMAGE_TAG}
        
        echo "âœ… ConfiguraÃ§Ã£o do Pulumi atualizada!"
        
        # ========================================
        # 2. ATUALIZAR ECS SERVICE
        # ========================================
        echo "ğŸš€ Atualizando serviÃ§o ECS..."

        echo "cluster: ${{github.event.inputs.ecs_cluster}}"
        echo "service: ${{github.event.inputs.service_name}}"
        
        # Obter a task definition atual
        echo "ğŸ“‹ Obtendo task definition atual..."
        TASK_DEFINITION_ARN=$(aws ecs describe-services \
          --cluster ${{github.event.inputs.ecs_cluster}} \
          --services ${{github.event.inputs.service_name}} \
          --query 'services[0].taskDefinition' \
          --output text)
        
        echo "ğŸ“„ Task Definition ARN: ${TASK_DEFINITION_ARN}"
        
        # Baixar a task definition atual
        aws ecs describe-task-definition \
          --task-definition ${TASK_DEFINITION_ARN} \
          --query 'taskDefinition' \
          --output json > task-definition.json
        
        # Atualizar a imagem na task definition
        echo "ğŸ”§ Atualizando imagem na task definition..."
        
        # Usar jq para atualizar a imagem (assumindo que Ã© o primeiro container)
        jq --arg IMAGE_URI "${IMAGE_URI}" \
          '.containerDefinitions[0].image = $IMAGE_URI | 
           del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
          task-definition.json > new-task-definition.json
        
        echo "ğŸ“‹ Nova task definition:"
        cat new-task-definition.json | jq '.containerDefinitions[0].image'
        
        # Registrar nova task definition
        echo "ğŸ“ Registrando nova task definition..."
        NEW_TASK_DEFINITION_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-definition.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "âœ… Nova task definition registrada: ${NEW_TASK_DEFINITION_ARN}"
        
        # Atualizar o serviÃ§o com a nova task definition
        echo "ğŸš€ Atualizando serviÃ§o..."
        aws ecs update-service \
          --cluster ${CLUSTER_NAME} \
          --service ${SERVICE_NAME} \
          --task-definition ${NEW_TASK_DEFINITION_ARN} \
          --force-new-deployment
        
        
        # ========================================
        # 3. REFRESH PULUMI STATE (SINCRONIZAR COM REALIDADE)
        # ========================================
        echo "ğŸ”„ Executando Pulumi refresh para sincronizar estado..."
        echo "ğŸ“ Isso vai atualizar o state file com as mudanÃ§as feitas diretamente no AWS"
        
        # Fazer refresh do estado para evitar drift
        if pulumi refresh --yes --stack "${STACK_NAME}"; then
          echo "âœ… Pulumi state atualizado com sucesso!"
          echo "ğŸ“Š Estado sincronizado entre Pulumi e AWS"
        else
          echo "âš ï¸ Aviso: Falha no pulumi refresh, mas deployment foi concluÃ­do"
          echo "ğŸ’¡ Considere executar 'pulumi refresh' manualmente depois"
        fi

        # ========================================
        # 4. COMMIT MUDANÃ‡AS DO PULUMI
        # ========================================
        echo "ğŸ’¾ Fazendo commit das mudanÃ§as na configuraÃ§Ã£o..."
        
        # Verificar se hÃ¡ mudanÃ§as
        if git diff --quiet; then
          echo "â„¹ï¸ Nenhuma mudanÃ§a para commit"
        else
          git config --global user.email "ci@valornet.com"
          git config --global user.name "CI/CD Bot"
          
          git add Pulumi.${STACK_NAME}.yaml
          git commit -m "ğŸ¤– ci: update ${SERVICE_NAME} imageTag to ${IMAGE_TAG}"
          
          # Push mudanÃ§as
          git push origin main
          
          echo "âœ… ConfiguraÃ§Ã£o commitada e enviada!"
        fi
        
        echo "ğŸ‰ Processo concluÃ­do com sucesso!"
        echo "ğŸ“Š Resumo:"
        echo "  - Config Pulumi: âœ… Atualizada"
        echo "  - ECS Service: âœ… Atualizado"
        echo "  - ServiÃ§o: ${SERVICE_NAME}"
        echo "  - Nova imagem: ${IMAGE_TAG}"